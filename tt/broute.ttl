;init.
connect '/C=5' ;RL7023 StickのCOMポート番号を入力
setbaud 115200 ;baudrateの数値の設定
timeout = 0
fileopen fh 'log.txt' 1

;ユーザーが設定する領域
aliveInterval = 900 ;SKPINGで疎通確認する頻度を[s]で指定
rbid = 'dummy' ;32桁の数字
pwd = 'dummy' ;何桁かの文字列
addr = 'dummy' ;接続先のipv6アドレス
channel = ''
panid = ''
;ユーザーが設定する領域ここまで

send 'SKSETPWD C ' pwd
sendln
sendln
send 'SKSETRBID ' rbid
sendln

sendln 'If you want to scan a your smame, you have to input **scan**'
sendln 'If you had scaned, please input **f**'
waitregex '^scan\n' '^f\r'
if result == 1 call Scan

:mainLoop
timeout = 0
send 'SKPING 0 ' addr
sendln
wait 'EPONG' 'EVENT 24' 'EVENT 29' 'ERXUDP'
if result == 1 timeout = aliveInterval
if result == 2 call Join
if result == 3 call Event29
if result == 4 call ERXUDPEA
sendln 'When input r, Get instant power value'
waitregex '^r\r' 'EVENT 29' 'ERXUDP'
if result == 1 call InstantPower
if result == 2 call Event29
if result == 3 call ERXUDPEA
goto mainloop
end



:Scan
send 'SKSCAN 3 FFFFFFFF 6 0'
sendln
addr = '  Addr:'
wait '  Addr:'
strtrim inputstr addr
sendln inputstr
end
return


:InstantPower
TID = '3304'
ESV = '62'
EPC = 'E7'

prevTO = timeout
timeout = 130
call StructFrame
call SkSendTo
wait TID
timeout = prevTO
strmatch inputstr '.*1081\h{4}02880105FF017201E704(\h{8})'
sendln result
str2int gp1 groupmatchstr1
sprintf2 p 'InstantPower: %d' gp1
sendln p
sendln
return


:StructFrame
frame = ''
strconcat frame '10' ;EHD1 ECHONET Lite規格だぞ
strconcat frame '81' ;規定電文形式ですぞ
strconcat frame TID ;トランザクションID なんでもいい
strconcat frame '05FF01' ;Send Echonet Object
strconcat frame '028801' ;Receive Echonet Object
strconcat frame ESV ;読み取りなのか通知なのかとか
strconcat frame '01' ;続くプロパティの数
strconcat frame EPC ;プロパティ種別の設定 Appendix参照
strconcat frame '00' ;読み取りなので続くバイトはないです 0です
return


:SkSendTo
; 文字数 → バイト数
strlen frame
lenByte = result / 2

sprintf2 length '%04X ' lenByte
; SKSENDTO（データ長はバイト数）

send 'SKSENDTO 1 ' addr ' 0E1A 1 0 ' length 

; 16進文字列 → バイト配列
for i 0 lenByte-1
    pos = i * 2 + 1
    strcopy frame pos 2 hex
    strbin = '$'
    strconcat strbin hex
    str2int bin strbin
    sendbinary bin
next
sendln
return


:ERXUDPEA
strmatch inputstr '1081\h{4}02880105FF017402EA0B(\h{4})(\h{2})(\h{2})(\h{2})(\h{2})(\h{2})(\h{8})'
if result == 0 return
res = ''
sprintf2 d '%04d-' groupmatchstr1
strconcat res d
sprintf2 d '%02d-' groupmatchstr2
strconcat res d
sprintf2 d '%02d_T' groupmatchstr3
strconcat res d
sprintf2 d '%02d:' groupmatchstr4
strconcat res d
sprintf2 d '%02d:' groupmatchstr5
strconcat res d
sprintf2 d '%02d,' groupmatchstr6
strconcat res d
strconcat res groupmatchstr7
fileseek fh 0 2
filewriteln fh res
return


:Event29
prevTO = timeout
timeout = 130
wait 'EVENT 25'
timeout = prevTO
if result == 1 return

send 'SKREJOIN\r\n'
wait 'OK' 'EVENT 24' ;たぶんOKではない EVENT 25でいいのか？
if result == 2 call Join
return


:Join
send 'SKSREG S2 ' channel '\r\n'
send 'SKSREG S3 ' panid '\r\n'
send 'SKJOIN ' addr '\r\n'
waitln 'EVENT 25' 'EVENT 24'
if result == 2 goto Join
return
