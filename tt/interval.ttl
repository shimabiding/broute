;Terminal設定がCR＋LFになっているか確認してね
connect '/C=5'
setbaud 115200

pwd = ''
bid = ''

aliveInterval = 10 ;econet


inputbox 'pwd' 'please pwd'
pwd = inputstr
sendln 'SKSETPWD C ' pwd
waitln 'OK'
inputbox 'bid' 'please bid'
bid = inputstr
sendln 'SKSETRBID' bid
waitln 'OK'


fileopen fh 'dokoda.txt' 1

call Join


while 1 == 1
    timeout = aliveInterval
    waitregex '^r\r'
    if result == 0 then
        call Alive
    else
        call InstantPower
    endif
endwhile

end



:Join

/*
strdim scanRes 5
scanRes[0] = '  Channnel:'
scanRes[1] = '  Channnel Page:'
scanRes[2] = '  Pan ID:'
scanRes[3] = '  Addr:'

do
    sendln 'SKSCAN 3 FFFFFFFF 6'

    for i 0 4
        waitln scanRes[i]
        if result == 0 then
            strconcat scanRes[i] 'No Res'
            messagebox scanRes[i] 'ERROR'
            end
        endif
        strtrim inputstr scanRes[i]
        scanRes[i] = inputstr
    next
loop while scanRes[3] == '  Addr:'

sendln 'SKLL64 ' scanRes[3]
waitln ':'
if result == 1 scanRes[3] = inputstr

sendln 'SKSREG S2 ' scanRes[0]
sendln 'SKSREG S3 ' scanRes[2]
sendln 'SKJOIN ' scanRes[3]

E25 = 1
while E25 == 1
    waitln 'EVENT24' 'EVENT25'
    if result == 1 continue
    if result == 2 E25 = 0
endwhile

return



:Alive
;SKREJOIN
;if
; sendln 'SKREJOIN'
;isAlive OK
;SKPING 0 
;recv / 30 min
return

:Recive
waitln 'ERXUDP' 'EVENT' 'EVENT29'
if result == 0 call a
if result == 1 call b
if result == 2 call c
return

:ERXUDP

return

:InstantPower
frame = '1081000005FF010288016201E700'
lenFrame = strlen frame
lenFlame = lenFrame / 2

send 'SKSENDTO 1 ' scanRes[3] ' 0E1A 1 0 ' lenFrame

for i 1 lenFrame
    strcopy 2*i-1 2 chipFrame
    dollers = '$'
    strconcat dollers chipFrame
    str2int bin dollers
    sendbinary bin
next
sendln ''


/*
frame = '1081000005FF010288016201E700'

; 文字数 → バイト数
strlen frame
lenByte = result / 2

; 整数配列を確保（intdim しか使えない）
intdim binArray lenByte

; 16進文字列 → バイト配列
for i 0 lenByte-1
    pos = i * 2 + 1
    strcopy frame pos 2 hex
    str2int binArray[i] '$' + hex
next

sprintf2 length '%04X' lenByte
; SKSENDTO（データ長はバイト数）
send 'SKSENDTO 1 FE80:0000:0000:0000:3AE0:8E00:01B5:0890 0E1A 1 0 ' length

; 一括バイナリ送信
sendbinary binArray
*/


;sendln $10$81$00$00$05$FF$01$02$88$01$62$01$E7$00
waitln 'E7'
waitln 'adfs'
;waitln 'E05'
messagebox inputstr 'insta'
getdate t "%Y-%m-%d %H:%M:%S"
strconcat t ' new\r\n'
fileseek fh 0 2
filewriteln fh t
return
